<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‡ DES_AIç«¶é¦¬äºˆæƒ³ - è¨ºæ–­ç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Yu Gothic", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            color: #1e293b;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.7; cursor: wait; }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.95rem;
            display: none;
        }
        .status.show { display: block; }
        .status.success { background: #dcfce7; color: #166534; border: 2px solid #86efac; }
        .status.error { background: #fef2f2; color: #dc2626; border: 2px solid #fca5a5; }
        .status.loading { background: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; }
        .log {
            background: #020617;
            color: #10b981;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        .result {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        .result h3 {
            margin: 0 0 10px 0;
            color: #667eea;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        .grid-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .label {
            font-size: 0.8rem;
            color: #64748b;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‡ DES_AIç«¶é¦¬äºˆæƒ³</h1>
            <p>ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ - å•é¡Œã®åŸå› ã‚’ç‰¹å®šä¸­</p>
        </div>
        
        <div class="card">
            <button class="btn" onclick="runDiagnostic()" id="testBtn">
                ğŸ” ãƒ‡ãƒ¼ã‚¿å–å¾—è¨ºæ–­ã‚’é–‹å§‹
            </button>
            
            <div id="status" class="status"></div>
            
            <div class="log" id="log">
                è¨ºæ–­å¾…æ©Ÿä¸­...<br>
                ä¸Šã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
            </div>
            
            <div id="result" class="result hidden"></div>
        </div>
    </div>

    <script>
        function addLog(message, isError = false) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = isError ? '#ef4444' : '#10b981';
            log.innerHTML = `<span style="color:${color}">[${time}] ${message}</span><br>` + log.innerHTML;
            console.log(`[${time}] ${message}`);
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = 'status show ' + type;
            status.innerHTML = message;
        }

        async function runDiagnostic() {
            const btn = document.getElementById('testBtn');
            const result = document.getElementById('result');
            
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ è¨ºæ–­å®Ÿè¡Œä¸­...';
            result.classList.add('hidden');
            
            addLog('=== DES_AIç«¶é¦¬äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­é–‹å§‹ ===');
            showStatus('ğŸ“¡ ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...', 'loading');
            
            // è¨ºæ–­1: AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ†ã‚¹ãƒˆ
            const predUrl = 'https://raw.githubusercontent.com/aipapa247272/keiba-auto-gist-updater/main/latest_predictions.json';
            addLog('è¨ºæ–­1: AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ†ã‚¹ãƒˆ');
            addLog('URL: ' + predUrl);
            
            try {
                const response1 = await fetch(predUrl + '?t=' + Date.now(), { 
                    cache: 'no-cache',
                    method: 'GET'
                });
                
                addLog(`HTTPå¿œç­”: ${response1.status} ${response1.statusText}`);
                
                if (!response1.ok) {
                    throw new Error(`HTTP ${response1.status}: ${response1.statusText}`);
                }
                
                const text1 = await response1.text();
                addLog(`ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${text1.length} bytes`);
                
                const data1 = JSON.parse(text1);
                addLog('JSONè§£æ: æˆåŠŸ');
                addLog(`ãƒ‡ãƒ¼ã‚¿æ§‹é€ : ymd=${data1.ymd}, selected_predictions=${data1.selected_predictions?.length}ä»¶`);
                
                if (data1.selected_predictions && data1.selected_predictions.length > 0) {
                    showStatus('âœ… AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
                    displayResults(data1, 'AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿');
                    addLog('=== è¨ºæ–­å®Œäº†: AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«åˆ©ç”¨å¯èƒ½ ===');
                } else {
                    throw new Error('AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                }
                
            } catch (error1) {
                addLog(`AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error1.message}`, true);
                
                // è¨ºæ–­2: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ã®å–å¾—ãƒ†ã‚¹ãƒˆ
                const rawUrl = 'https://raw.githubusercontent.com/aipapa247272/keiba-auto-gist-updater/main/latest_race_data.json';
                addLog('è¨ºæ–­2: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ†ã‚¹ãƒˆ');
                addLog('URL: ' + rawUrl);
                
                try {
                    const response2 = await fetch(rawUrl + '?t=' + Date.now(), { cache: 'no-cache' });
                    addLog(`HTTPå¿œç­”: ${response2.status} ${response2.statusText}`);
                    
                    if (!response2.ok) {
                        throw new Error(`HTTP ${response2.status}: ${response2.statusText}`);
                    }
                    
                    const text2 = await response2.text();
                    addLog(`ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${text2.length} bytes`);
                    
                    const data2 = JSON.parse(text2);
                    addLog('JSONè§£æ: æˆåŠŸ');
                    addLog(`ãƒ‡ãƒ¼ã‚¿æ§‹é€ : ymd=${data2.ymd}, races=${data2.races?.length}ä»¶`);
                    
                    if (data2.races && data2.races.length > 0) {
                        showStatus('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
                        displayResults(data2, 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰');
                        addLog('=== è¨ºæ–­å®Œäº†: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨å¯èƒ½ ===');
                    } else {
                        throw new Error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚‚ç©ºã§ã™');
                    }
                    
                } catch (error2) {
                    addLog(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error2.message}`, true);
                    showStatus('âŒ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    addLog('=== è¨ºæ–­å®Œäº†: ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ ===', true);
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ è¨ºæ–­ã‚’å†å®Ÿè¡Œ';
            }
        }

        function displayResults(data, dataType) {
            const result = document.getElementById('result');
            
            const ymd = String(data.ymd || '');
            const date = ymd.length === 8 ? 
                `${ymd.slice(0,4)}/${ymd.slice(4,6)}/${ymd.slice(6,8)}` : 'ä¸æ˜';
            
            let raceCount = 0;
            let totalRaces = 0;
            
            if (data.selected_predictions) {
                raceCount = data.selected_predictions.length;
                totalRaces = data.summary?.total_races || 0;
            } else if (data.races) {
                totalRaces = data.races.length;
                raceCount = Math.min(5, data.races.filter(r => r.horses && r.horses.length >= 5).length);
            }
            
            result.innerHTML = `
                <h3>ğŸ“Š è¨ºæ–­çµæœ - ${dataType}</h3>
                <div class="grid">
                    <div class="grid-item">
                        <div class="value">${date}</div>
                        <div class="label">å¯¾è±¡æ—¥</div>
                    </div>
                    <div class="grid-item">
                        <div class="value">${raceCount}R</div>
                        <div class="label">è¡¨ç¤ºå¯èƒ½ãƒ¬ãƒ¼ã‚¹</div>
                    </div>
                    <div class="grid-item">
                        <div class="value">${totalRaces}R</div>
                        <div class="label">å…¨ãƒ¬ãƒ¼ã‚¹æ•°</div>
                    </div>
                    <div class="grid-item">
                        <div class="value">æ­£å¸¸</div>
                        <div class="label">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #dcfce7; border-radius: 8px; color: #166534; font-size: 0.9rem;">
                    <strong>âœ… è¨ºæ–­æˆåŠŸ</strong><br>
                    ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚å…ƒã®ç¾ã—ã„ãƒ‡ã‚¶ã‚¤ãƒ³ç‰ˆã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
                </div>
            `;
            result.classList.remove('hidden');
        }

        // è‡ªå‹•è¨ºæ–­å®Ÿè¡Œ
        window.addEventListener('load', function() {
            addLog('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å®Œäº†');
            addLog('è¨ºæ–­ã®æº–å‚™ãŒã§ãã¾ã—ãŸ');
            setTimeout(() => {
                addLog('è‡ªå‹•è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™...');
                runDiagnostic();
            }, 2000);
        });
    </script>
</body>
</html>
