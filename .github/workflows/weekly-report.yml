name: Generate Weekly Report

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 09:00 JST (00:00 UTC) ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Calculate week dates
        id: dates
        run: |
          # ä»Šé€±ã®æœˆæ›œæ—¥ã‚’å–å¾—
          MONDAY=$(TZ=Asia/Tokyo date -d "monday" +%Y%m%d)
          echo "monday=${MONDAY}" >> $GITHUB_OUTPUT
          echo "ğŸ“… Week starting: ${MONDAY}"
      
      - name: Collect week data
        run: |
          # éå»7æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
          echo "ğŸ“¦ Collecting data for the past week..."
          
          # äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã¨çµæœãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
          python3 << 'EOF'
import json
import glob
from datetime import datetime, timedelta

# ä»Šé€±ã®æœˆæ›œæ—¥ã‹ã‚‰æ—¥æ›œæ—¥ã¾ã§ã®æ—¥ä»˜ã‚’ç”Ÿæˆ
today = datetime.now()
monday = today - timedelta(days=today.weekday())
dates = [(monday + timedelta(days=i)).strftime('%Y%m%d') for i in range(7)]

all_predictions = []
all_results = []

# å„æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
for date in dates:
    # äºˆæƒ³ãƒ‡ãƒ¼ã‚¿
    try:
        with open(f'final_predictions_{date}.json', 'r') as f:
            data = json.load(f)
            all_predictions.extend(data.get('selected_predictions', []))
    except FileNotFoundError:
        pass
    
    # çµæœãƒ‡ãƒ¼ã‚¿
    try:
        with open(f'results_{date}.json', 'r') as f:
            data = json.load(f)
            all_results.extend(data.get('races', []))
    except FileNotFoundError:
        pass

# ãƒãƒ¼ã‚¸ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
with open('weekly_predictions.json', 'w') as f:
    json.dump({'selected_predictions': all_predictions}, f, ensure_ascii=False)

with open('weekly_results.json', 'w') as f:
    json.dump({'races': all_results}, f, ensure_ascii=False)

print(f"âœ… Collected {len(all_predictions)} predictions and {len(all_results)} results")
EOF
      
      - name: Generate weekly report
        run: |
          python3 scripts/generate_reports.py weekly weekly_predictions.json weekly_results.json statistics.json
      
      - name: Commit and push report
        run: |
          MONDAY="${{ steps.dates.outputs.monday }}"
          REPORT_FILE="weekly_report_${MONDAY}.json"
          
          if [ -f "${REPORT_FILE}" ]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add "${REPORT_FILE}"
            git commit -m "ğŸ“Š Generate weekly report for week of ${MONDAY}" || echo "No changes to commit"
            git push || echo "Nothing to push"
            echo "âœ… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: ${REPORT_FILE}"
          else
            echo "âŒ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
