name: Generate Monthly Report

on:
  schedule:
    # æ¯æœˆ1æ—¥ 09:00 JST (00:00 UTC) ã«å®Ÿè¡Œ
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Calculate month
        id: month
        run: |
          YEAR_MONTH=$(TZ=Asia/Tokyo date -d "last month" +%Y%m)
          echo "year_month=${YEAR_MONTH}" >> $GITHUB_OUTPUT
          echo "ğŸ“… Target month: ${YEAR_MONTH}"
      
      - name: Collect month data
        run: |
          YEAR_MONTH="${{ steps.month.outputs.year_month }}"
          echo "ğŸ“¦ Collecting data for ${YEAR_MONTH}..."
          
          # å…ˆæœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
          python3 << EOF
import json
import glob
from datetime import datetime, timedelta
import calendar

# å…ˆæœˆã®å¹´æœˆã‚’å–å¾—
year_month = "${YEAR_MONTH}"
year = int(year_month[:4])
month = int(year_month[4:6])

# å…ˆæœˆã®æ—¥æ•°ã‚’å–å¾—
_, num_days = calendar.monthrange(year, month)

all_predictions = []
all_results = []

# å…ˆæœˆã®å…¨æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
for day in range(1, num_days + 1):
    date = f"{year}{month:02d}{day:02d}"
    
    # äºˆæƒ³ãƒ‡ãƒ¼ã‚¿
    try:
        with open(f'final_predictions_{date}.json', 'r') as f:
            data = json.load(f)
            all_predictions.extend(data.get('selected_predictions', []))
    except FileNotFoundError:
        pass
    
    # çµæœãƒ‡ãƒ¼ã‚¿
    try:
        with open(f'results_{date}.json', 'r') as f:
            data = json.load(f)
            all_results.extend(data.get('races', []))
    except FileNotFoundError:
        pass

# ãƒãƒ¼ã‚¸ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
with open('monthly_predictions.json', 'w') as f:
    json.dump({'selected_predictions': all_predictions}, f, ensure_ascii=False)

with open('monthly_results.json', 'w') as f:
    json.dump({'races': all_results}, f, ensure_ascii=False)

print(f"âœ… Collected {len(all_predictions)} predictions and {len(all_results)} results for {year_month}")
EOF
      
      - name: Generate monthly report
        run: |
          python3 scripts/generate_reports.py monthly monthly_predictions.json monthly_results.json statistics.json
      
      - name: Commit and push report
        run: |
          YEAR_MONTH="${{ steps.month.outputs.year_month }}"
          REPORT_FILE="monthly_report_${YEAR_MONTH}.json"
          
          if [ -f "${REPORT_FILE}" ]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add "${REPORT_FILE}"
            git commit -m "ğŸ“Š Generate monthly report for ${YEAR_MONTH}" || echo "No changes to commit"
            git push || echo "Nothing to push"
            echo "âœ… æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: ${REPORT_FILE}"
          else
            echo "âŒ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
