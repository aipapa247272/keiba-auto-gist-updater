name: Daily Select

on:
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (YYYYMMDD, optional)'
        required: false
        type: string
  schedule:
    - cron: "0 14 * * *"  # æ¯æ—¥23:00 JST (14:00 UTC)

jobs:
  daily-select:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install beautifulsoup4 requests
      
      - name: Get date
        id: get_ymd
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            echo "ymd=${{ github.event.inputs.target_date }}" >> $GITHUB_OUTPUT
          else
            echo "ymd=$(date -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
          fi
      
      - name: Run daily select
        run: |
          python scripts/daily_select.py ${{ steps.get_ymd.outputs.ymd }}
      
      - name: Check race cancellation
        id: check_cancel
        run: |
          if [ ! -f "today_jobs.latest.json" ]; then
            echo "âŒ ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "cancelled=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          RACE_COUNT=$(jq '.total_race_count // 0' today_jobs.latest.json)
          if [ "$RACE_COUNT" -eq 0 ]; then
            echo "â„¹ï¸ æœ¬æ—¥ã¯é–‹å‚¬ãƒ¬ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“"
            echo "cancelled=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "cancelled=false" >> $GITHUB_OUTPUT
      
      - name: Fetch shutuba data
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/fetch_shutuba_table.py ${{ steps.get_ymd.outputs.ymd }}
      
      - name: Fetch past races data
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/fetch_past_races.py ${{ steps.get_ymd.outputs.ymd }}
      
      - name: Calculate DES scores
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/calculate_des_scores.py ${{ steps.get_ymd.outputs.ymd }}
      
      - name: Calculate NEW scores
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/calculate_new_score.py race_data_${{ steps.get_ymd.outputs.ymd }}.json
      
      - name: Select predictions
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/select_predictions.py ${{ steps.get_ymd.outputs.ymd }}
      
      - name: Commit race_data JSON
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add race_data_*.json 2>/dev/null || true
          git add today_jobs.latest.json 2>/dev/null || true
          git add predictions_*.md 2>/dev/null || true
          git add final_predictions_*.json 2>/dev/null || true
          git add warnings_report_*.md 2>/dev/null || true
          git add latest_predictions.json 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            git commit -m "chore: update race data with predictions for ${{ steps.get_ymd.outputs.ymd }}"
            git push
          else
            echo "ğŸ“ å¤‰æ›´ãªã—(ã‚³ãƒŸãƒƒãƒˆä¸è¦)"
          fi
      
      - name: Generate final output
        if: steps.check_cancel.outputs.cancelled == 'false'
        continue-on-error: true
        run: |
          echo "âœ… äºˆæƒ³ç”Ÿæˆå®Œäº†"
      
      - name: Validate predictions
        if: steps.check_cancel.outputs.cancelled == 'false'
        continue-on-error: true
        run: |
          if [ -f "latest_predictions.json" ]; then
            echo "âœ… latest_predictions.json ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸ latest_predictions.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
