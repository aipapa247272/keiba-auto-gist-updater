name: Daily Select

on:
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (YYYYMMDD, leave empty for tomorrow)'
        required: false
        type: string
  schedule:
    - cron: '0 14 * * *'  # 23:00 JST daily

jobs:
  daily-select:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Get date
        id: get_date
        run: |
          if [ -z "${{ github.event.inputs.target_date }}" ]; then
            echo "date=$(TZ=Asia/Tokyo date -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
          else
            echo "date=${{ github.event.inputs.target_date }}" >> $GITHUB_OUTPUT
          fi
          echo "Target date: $(cat $GITHUB_OUTPUT | grep date | cut -d'=' -f2)"

      - name: Run daily select
        run: |
          python scripts/daily_select.py ${{ steps.get_date.outputs.date }}

      - name: Check race cancellation
        id: check_cancel
        run: |
          # âœ… ãƒ•ãƒ«ãƒ‘ã‚¹æŒ‡å®šã‚’è¿½åŠ 
          JSON_FILE="${GITHUB_WORKSPACE}/today_jobs.latest.json"
          
          echo "ğŸ“‚ Checking file: $JSON_FILE"
          
          if [ ! -f "$JSON_FILE" ]; then
            echo "âŒ ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "cancelled=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… File found"
          
          RACE_COUNT=$(jq '.total_race_count // 0' "$JSON_FILE")
          
          echo "ğŸ“Š Race count: $RACE_COUNT"
          
          if [ "$RACE_COUNT" -eq 0 ]; then
            echo "â„¹ï¸ æœ¬æ—¥ã¯é–‹å‚¬ãƒ¬ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“"
            echo "cancelled=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… æœ¬æ—¥ã¯${RACE_COUNT}ãƒ¬ãƒ¼ã‚¹é–‹å‚¬"
            echo "cancelled=false" >> $GITHUB_OUTPUT
          fi

      - name: Fetch shutuba data
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/fetch_shutuba.py ${{ steps.get_date.outputs.date }}

      - name: Fetch past races data
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/fetch_past_races.py ${{ steps.get_date.outputs.date }}

      - name: Calculate DES scores
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/calculate_des.py ${{ steps.get_date.outputs.date }}

      - name: Calculate NEW scores
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/calculate_new_score.py race_data_${{ steps.get_date.outputs.date }}.json

      - name: Select predictions
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          python scripts/select_predictions.py ${{ steps.get_date.outputs.date }}

      - name: Commit race_data JSON
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add race_data_*.json
          git diff --cached --quiet || git commit -m "Add race_data for ${{ steps.get_date.outputs.date }}"
          git push

      - name: Generate final output
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          echo "âœ… äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸ"

      - name: Validate predictions
        if: steps.check_cancel.outputs.cancelled == 'false'
        run: |
          if [ ! -f "latest_predictions.json" ]; then
            echo "âŒ latest_predictions.json ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          echo "âœ… latest_predictions.json ã‚’ç¢ºèªã—ã¾ã—ãŸ"
