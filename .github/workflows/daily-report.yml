name: Generate Daily Report

on:
  schedule:
    # æ¯æ—¥21:00 JST (12:00 UTC) ã«å®Ÿè¡Œ
    - cron: '0 12 * * *'
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (YYYYMMDD)'
        required: false
        default: ''

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Determine target date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            TARGET_DATE="${{ github.event.inputs.target_date }}"
          else
            TARGET_DATE=$(TZ=Asia/Tokyo date +%Y%m%d)
          fi
          echo "target_date=${TARGET_DATE}" >> $GITHUB_OUTPUT
          echo "ğŸ“… Target date: ${TARGET_DATE}"
      
      - name: Download required files
        run: |
          TARGET_DATE="${{ steps.date.outputs.target_date }}"
          
          # äºˆæƒ³ãƒ‡ãƒ¼ã‚¿
          if [ -f "final_predictions_${TARGET_DATE}.json" ]; then
            cp "final_predictions_${TARGET_DATE}.json" predictions.json
          elif [ -f "latest_predictions.json" ]; then
            cp latest_predictions.json predictions.json
          else
            echo "âš ï¸ äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo '{"selected_predictions":[]}' > predictions.json
          fi
          
          # çµæœãƒ‡ãƒ¼ã‚¿
          if [ -f "results_${TARGET_DATE}.json" ]; then
            cp "results_${TARGET_DATE}.json" results.json
          elif [ -f "latest_results.json" ]; then
            cp latest_results.json results.json
          else
            echo "âš ï¸ çµæœãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo '{"races":[]}' > results.json
          fi
          
          # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
          if [ -f "statistics.json" ]; then
            cp statistics.json statistics.json
          else
            echo "âš ï¸ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo '{}' > statistics.json
          fi
      
      - name: Generate daily report
        run: |
          python3 scripts/generate_reports.py daily predictions.json results.json statistics.json
      
      - name: Commit and push report
        run: |
          TARGET_DATE="${{ steps.date.outputs.target_date }}"
          REPORT_FILE="daily_report_${TARGET_DATE}.json"
          
          if [ -f "${REPORT_FILE}" ]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add "${REPORT_FILE}"
            git commit -m "ğŸ“Š Generate daily report for ${TARGET_DATE}" || echo "No changes to commit"
            git push || echo "Nothing to push"
            echo "âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: ${REPORT_FILE}"
          else
            echo "âŒ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
